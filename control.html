<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Tagglo Control</title>
  <style>
    body { font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 18px; color:#111; }
    .row { display:flex; gap:8px; align-items:center; margin-bottom:10px; }
    input[type="text"] { width: 560px; padding:8px 10px; border:1px solid #ccc; border-radius:6px; }
    button { padding:8px 12px; border:0; border-radius:6px; background:#111; color:#fff; cursor:pointer; }
    button[disabled] { opacity:.5; cursor:not-allowed; }
    #out { white-space: pre; background:#fafafa; border:1px solid #eee; padding:10px; border-radius:8px; margin-top:12px; max-height: 44vh; overflow:auto; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; }
    .pill { display:inline-block; background:#eee; border-radius:999px; padding:2px 8px; margin-right:6px; font-size:12px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .box { border:1px solid #eee; border-radius:8px; padding:10px; background:#fff; }
    .label { font-weight:700; margin-bottom:4px; }
    .imgs { display:flex; gap:6px; flex-wrap:wrap; }
    .imgs img { height:64px; border-radius:6px; border:1px solid #eee; cursor:pointer; transition:transform 0.2s; }
    .imgs img:hover { transform:scale(1.05); }

    /* Image Overlay Modal */
    .image-overlay { 
      position:fixed; top:0; left:0; width:100%; height:100%; 
      background:rgba(0,0,0,0.9); display:none; z-index:1000; 
      justify-content:center; align-items:center; 
    }
    .image-overlay.show { display:flex; }
    .overlay-content { 
      position:relative; max-width:90%; max-height:90%; 
      display:flex; justify-content:center; align-items:center; 
    }
    .overlay-image { 
      max-width:100%; max-height:100%; object-fit:contain; 
      border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,0.5); 
    }
    .close-overlay { 
      position:absolute; top:-40px; right:0; background:none; 
      border:none; color:white; font-size:24px; cursor:pointer; 
      padding:8px; border-radius:4px; 
    }
    .close-overlay:hover { background:rgba(255,255,255,0.2); }
    .ai-suggest-btn {
      margin-left: 4px; padding: 2px 6px; font-size: 10px; 
      background: #4CAF50; color: white; border: none; border-radius: 3px; 
      cursor: pointer; vertical-align: middle;
    }
    .ai-suggest-btn:hover { background: #45a049; }
    .ai-suggest-btn:disabled { background: #ccc; cursor: not-allowed; }
    .ai-cache-status {
      margin-left: 12px; padding: 4px 8px; font-size: 11px; border-radius: 4px;
      background: #ffebee; color: #c62828; border: 1px solid #ef9a9a;
    }
    .ai-cache-status.ready {
      background: #e8f5e8; color: #2e7d32; border-color: #81c784;
    }
    .suggestion-panel {
      margin-top: 8px; padding: 8px; background: #e8f5e8; 
      border-radius: 4px; border-left: 4px solid #4CAF50; display: none;
    }
    .suggestion-comparison {
      display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 6px;
    }
    .suggestion-box {
      padding: 6px; background: white; border-radius: 3px; font-size: 11px;
    }
    .use-suggestion-btn {
      margin-top: 6px; padding: 4px 8px; background: #4CAF50; 
      color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;
    }
    .validation-panel {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      max-width: 80%; max-height: 80%; overflow-y: auto; z-index: 1000; display: none;
    }
    .validation-header {
      padding: 16px; border-bottom: 1px solid #eee; background: #f9f9f9;
      font-weight: bold; display: flex; justify-content: space-between; align-items: center;
    }
    .validation-content {
      padding: 16px; max-height: 60vh; overflow-y: auto;
    }
    .field-card {
      border: 1px solid #eee; border-radius: 6px; margin-bottom: 12px; overflow: hidden;
    }
    .field-header {
      background: #f5f5f5; padding: 8px 12px; font-weight: bold; font-size: 13px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .field-status {
      padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: normal;
    }
    .field-status.success { background: #e8f5e8; color: #2e7d32; }
    .field-status.failed { background: #ffebee; color: #c62828; }
    .field-body {
      padding: 10px 12px; background: white;
    }
    .field-preview {
      margin-bottom: 8px; font-size: 12px;
    }
    .field-selector {
      font-family: monospace; background: #f8f8f8; padding: 4px 6px; border-radius: 3px;
      font-size: 11px; color: #666; margin-top: 4px;
    }
    .image-urls {
      max-height: 120px; overflow-y: auto; background: #f8f8f8; padding: 6px; border-radius: 3px;
      margin-top: 4px;
    }
    .image-url {
      font-size: 10px; font-family: monospace; color: #666; margin-bottom: 2px; word-break: break-all;
    }
    .validation-footer {
      padding: 12px 16px; border-top: 1px solid #eee; background: #f9f9f9;
      display: flex; gap: 8px; justify-content: flex-end;
    }
  </style>
  <style>
    /* Mobile Preview Styles */
    .device-btn { 
      padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; 
      font-size: 12px; transition: all 0.2s; margin-right: 8px;
    }
    .device-btn.active { background: #2196F3; color: white; }
    .device-btn:not(.active) { background: #f0f0f0; color: #666; }
    
    .mobile-container {
      border: 1px solid #ddd; border-radius: 0 0 12px 12px; background: #f8f9fa;
      padding: 12px; margin-top: 12px; height: 450px; overflow-y: auto;
      transition: width 0.3s ease; scroll-behavior: smooth;
    }
    .mobile-container.iphone { width: 375px; max-width: 100%; }
    .mobile-container.ipad { width: 768px; max-width: 100%; }
    
    .mobile-content {
      background: white; border-radius: 8px; padding: 12px;
      min-height: 420px; position: relative;
    }
    
    .mobile-grid {
      display: grid; gap: 12px; grid-template-columns: 1fr 1fr;
      grid-auto-rows: masonry; /* Future masonry support */
    }
    .mobile-container.ipad .mobile-grid {
      grid-template-columns: 1fr 1fr 1fr !important;
    }
    
    /* Mobile Image Detail Modal (Pinterest-style) */
    .mobile-image-modal {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: white;
      z-index: 1000;
      display: none;
      flex-direction: column;
    }
    
    .mobile-image-modal.show {
      display: flex;
    }
    
    .mobile-modal-header {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid #eee;
      background: white;
      position: sticky;
      top: 0;
      z-index: 1001;
    }
    
    .mobile-back-btn {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #333;
      padding: 4px 8px;
      border-radius: 50%;
      transition: background 0.2s;
    }
    
    .mobile-back-btn:hover {
      background: #f0f0f0;
    }
    
    .mobile-header-space {
      flex: 1;
    }
    
    .mobile-save-btn {
      background: #E60023;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .mobile-save-btn:hover {
      background: #c8001e;
    }
    
    .mobile-modal-content {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow: hidden;
    }
    
    .mobile-modal-image {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .mobile-modal-footer {
      padding: 12px 16px;
      border-top: 1px solid #eee;
      background: #f9f9f9;
      font-size: 12px;
      color: #666;
    }
    
    .mobile-grid-item {
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s;
      background: #f5f5f5;
      position: relative;
    }
    
    .mobile-grid-item:hover {
      transform: translateY(-4px);
    }
    
    .mobile-grid-item img {
      width: 100%;
      height: auto;
      display: block;
    }
    
    .mobile-image-number {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0,0,0,0.6);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .mobile-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .mobile-section-title {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }
    
    .mobile-image-count {
      font-size: 12px;
      color: #666;
    }
  </style>
  <style>
    /* Debug Panel Styles */
    .debug-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      max-height: 40vh;
      background: #1e1e1e;
      border-top: 2px solid #333;
      z-index: 1000;
      display: none;
      flex-direction: column;
    }
    
    .debug-panel.show {
      display: flex;
    }
    
    .debug-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 16px;
      background: #2d2d2d;
      border-bottom: 1px solid #444;
    }
    
    .debug-title {
      color: #fff;
      font-weight: 600;
      font-size: 13px;
    }
    
    .debug-controls {
      display: flex;
      gap: 8px;
    }
    
    .debug-btn {
      padding: 4px 12px;
      font-size: 11px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: #444;
      color: #fff;
    }
    
    .debug-btn:hover {
      background: #555;
    }
    
    .debug-content {
      flex: 1;
      overflow-y: auto;
      padding: 12px 16px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      line-height: 1.5;
    }
    
    .debug-entry {
      display: flex;
      align-items: flex-start;
      margin-bottom: 8px;
      padding: 6px 8px;
      border-radius: 4px;
      background: #252525;
    }
    
    .debug-entry.info { border-left: 3px solid #2196F3; }
    .debug-entry.success { border-left: 3px solid #4CAF50; }
    .debug-entry.warning { border-left: 3px solid #FF9800; }
    .debug-entry.error { border-left: 3px solid #f44336; }
    .debug-entry.debug { border-left: 3px solid #9C27B0; }
    
    .debug-icon {
      margin-right: 8px;
      font-size: 14px;
    }
    
    .debug-message {
      flex: 1;
      color: #e0e0e0;
      word-break: break-word;
    }
    
    .debug-image-preview {
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
      background: #1a1a1a;
      padding: 8px;
      border-radius: 4px;
    }
    
    .debug-image-preview img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 4px;
      border: 1px solid #444;
    }
    
    .debug-image-info {
      flex: 1;
      font-size: 11px;
      color: #999;
    }
    
    .debug-image-score {
      font-size: 16px;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 4px;
    }
    
    .debug-image-score.kept {
      color: #4CAF50;
      background: rgba(76, 175, 80, 0.1);
    }
    
    .debug-image-score.rejected {
      color: #f44336;
      background: rgba(244, 67, 54, 0.1);
    }
  </style>
</head>
<body>
  <div class="row">
    <span id="statusEl"><span class="pill">Ready</span></span>
  </div>
  <div class="row">
    <input id="urlInput" type="text" placeholder="Paste product URL" />
    <button id="visitBtn">Load</button>
    <button id="memoryBtn" title="Scrape using saved selector memory only">Selector memory</button>
    <button id="saveBtn" disabled>Save (scrape)</button>
    <!-- LLM (compare) button ‚Äî added -->
    <button id="llmCompareBtn" title="Side-by-side baseline vs LLM">LLM (compare)</button>
    <button id="batchAIBtn" title="Get AI suggestions for all fields at once (saves tokens)">ü§ñ Batch AI All</button>
    <button id="copyDiagnosticsBtn" title="Copy structured diagnostic information for troubleshooting">üìã Copy Diagnostics</button>
    <span id="aiCacheStatus" class="ai-cache-status">ü§ñ AI cache: Not Ready</span>
  </div>

  <div id="panel" class="grid" style="display:none; margin-top:12px;">
    <div class="box">
      <div class="label">Scrape Result</div>
      <div id="summary"></div>
      <div id="images" class="imgs" style="margin-top:6px;"></div>
    </div>
    <div class="box">
      <div class="label">Mobile Preview</div>
      <!-- Mobile container directly, no validation wrappers -->
      <div id="mobileContainer" class="mobile-container iphone">
        <div id="mobileContent" class="mobile-content">
          <div id="mobileGrid" class="mobile-grid">
            <!-- Images will be populated here -->
          </div>
          <!-- In-Container Image Detail Modal -->
          <div id="mobileModal" class="mobile-image-modal">
            <div class="mobile-modal-header">
              <button class="mobile-back-btn" onclick="closeMobileModal()">‚Üê</button>
              <div class="mobile-header-space"></div>
              <button class="mobile-save-btn">Save</button>
            </div>
            <div class="mobile-modal-content">
              <img id="mobileModalImage" class="mobile-modal-image" src="" alt="Product Image">
            </div>
            <div class="mobile-modal-footer">
              <div id="mobileModalInfo"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="out"></div>

  <!-- Image Overlay Modal -->
  <div id="imageOverlay" class="image-overlay">
    <div class="overlay-content">
      <button class="close-overlay" onclick="closeImageOverlay()">&times;</button>
      <img id="overlayImage" class="overlay-image" src="" alt="Full Size Image">
    </div>
  </div>

  <!-- Debug Panel -->
  <div id="debugPanel" class="debug-panel">
    <div class="debug-header">
      <div class="debug-title">üêõ Debug Console</div>
      <div class="debug-controls">
        <button class="debug-btn" onclick="clearDebugOutput()">Clear</button>
        <button class="debug-btn" onclick="hideDebugPanel()">Close</button>
      </div>
    </div>
    <div id="debugContent" class="debug-content"></div>
  </div>

  <script>
    const summary = document.getElementById('summary');
    const images = document.getElementById('images');
    const out = document.getElementById('out');

    const okTitle = document.getElementById('okTitle');
    const okPrice = document.getElementById('okPrice');
    const okImages = document.getElementById('okImages');
    const okBrand = document.getElementById('okBrand');
    const okDesc = document.getElementById('okDesc');
    const panel = document.getElementById('panel');
    const statusEl = document.getElementById('statusEl');

    const visitBtn = document.getElementById('visitBtn');
    const memoryBtn = document.getElementById('memoryBtn');
    const saveBtn = document.getElementById('saveBtn');

    let currentUrl = '';
    let currentHost = '';
    let lastPayload = null;
    let lastSelectorsUsed = null;
    let aiCacheReady = false;

    const hostFrom = (url) => {
      try { return new URL(url).hostname.replace(/^www\./,''); }
      catch { return ''; }
    };

    const setSaveState = (disabled, label) => {
      saveBtn.disabled = disabled;
      saveBtn.textContent = label || 'Save (scrape)';
    };

    // Image Overlay Modal Functions
    function openImageOverlay(url) {
      const overlay = document.getElementById('imageOverlay');
      const image = document.getElementById('overlayImage');
      image.src = url;
      overlay.classList.add('show');
    }

    function closeImageOverlay() {
      const overlay = document.getElementById('imageOverlay');
      overlay.classList.remove('show');
    }

    // Close overlay when clicking outside the image
    document.getElementById('imageOverlay').addEventListener('click', function(e) {
      if (e.target === this) {
        closeImageOverlay();
      }
    });

    // ESC key to close overlay
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeImageOverlay();
      }
    });

    // Visit button
    visitBtn.onclick = async () => {
      const url = urlInput.value.trim();
      if (!url) return;
      currentUrl = url; // Track current URL for cache
      currentHost = hostFrom(url);
      panel.style.display = 'none';
      out.textContent = '';
      images.innerHTML = '';
      summary.innerHTML = '';
      statusEl.innerHTML = `<span class="pill">Loading ${currentHost}</span>`;
      await window.api.openProduct(url);
      

      // poll readiness and enable Save once likely hydrated
      setSaveState(true, 'Waiting for page‚Ä¶');
      const iv = setInterval(async () => {
        console.log('üîç Polling for page readiness...');
        const ok = await window.api.evalInProduct(`
          (async () => {
            const h1 = document.querySelector("h1,[itemprop='name']");
            const price = document.querySelector("[itemprop='price'],[data-price],[class*='price'] .money");
            const imgs = document.querySelector("img[src], picture source[srcset], [data-zoom-image], [data-large-image]");
            return !!(h1 && (price || imgs));
          })()
        `);
        if (ok) {
          clearInterval(iv);
          setSaveState(false, 'Save (scrape)');
          statusEl.innerHTML = `<span class="pill">Ready to scrape</span>`;
        }
      }, 500);
    };

    // Selector memory only
    memoryBtn.onclick = async () => {
      const url = urlInput.value.trim();
      if (!url) return alert('Paste a URL first.');
      const host = hostFrom(url);
      // First navigate to the target page to be in correct origin
      statusEl.innerHTML = `<span class="pill">Loading ${host}</span>`;
      panel.style.display = 'none'; images.innerHTML=''; summary.innerHTML=''; out.textContent='';
      
      await window.api.openProduct(url);
      await new Promise(r => setTimeout(r, 1500)); // Wait for page load
      
      const hasMem = await window.api.hasSelectorMemory(host);
      if (!hasMem) { 
        statusEl.innerHTML = `<span class="pill" style="background:#fdd; color:#900;">No Memory</span>`;
        alert('‚ùå No selector memory for this host yet. Use "Save (Scrape)" first.');
        return;
      }
      
      statusEl.innerHTML = `<span class="pill">Memory-only</span>`;
      try {
        const { result, selectorsUsed } = await window.api.scrapeCurrent({ mode: 'memoryOnly' });
        lastPayload = result || {}; lastSelectorsUsed = selectorsUsed || null;
        const imgs = Array.isArray(result?.images) ? result.images : [];
        summary.innerHTML = `
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
            <input type="checkbox" id="check_title" data-field="title">
            <label for="check_title" style="flex:1;"><b>Title:</b> ${result?.title || ''}</label>
          </div>
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
            <input type="checkbox" id="check_price" data-field="price">
            <label for="check_price" style="flex:1;"><b>Price:</b> ${result?.price || ''}</label>
          </div>
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
            <input type="checkbox" id="check_brand" data-field="brand">
            <label for="check_brand" style="flex:1;"><b>Brand:</b> ${result?.brand || ''}</label>
          </div>
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
            <input type="checkbox" id="check_url" data-field="url">
            <label for="check_url" style="flex:1;"><b>URL:</b> ${result?.url || ''}</label>
          </div>
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
            <input type="checkbox" id="check_description" data-field="description">
            <label for="check_description" style="flex:1;"><b>Description:</b> ${(result?.description || '').slice(0,240)}</label>
          </div>
          <button id="saveSelectorBtn" style="margin-top:8px; padding:6px 12px; background:#4CAF50; color:white; border:none; border-radius:4px; cursor:pointer;">üíæ Save Selectors (<span id="selectedCount">0</span> selected)</button>`;
        images.innerHTML = imgs.map((u, i) => `
          <div style="position:relative; display:inline-block;">
            <input type="checkbox" class="img-checkbox" data-field="images" data-index="${i}" data-url="${u}" style="position:absolute; top:4px; left:4px; z-index:1; width:16px; height:16px; cursor:pointer;">
            <img referrerpolicy="no-referrer" src="${u}" title="${u}" onclick="openImageOverlay('${u}')" style="display:block;">
          </div>`).join('');
        // Update mobile preview with scraped images
        updateMobilePreview(imgs);
        // Enhanced URL display with click-to-copy functionality (safe DOM approach)
        out.innerHTML = ''; // Clear first
        imgs.forEach((url, index) => {
          const itemDiv = document.createElement('div');
          itemDiv.className = 'image-url-item';
          itemDiv.style.cssText = `display: flex; align-items: center; padding: 4px 0; border-bottom: 1px solid #eee; background: ${index % 2 === 0 ? '#f9f9f9' : 'white'};`;
          
          const urlSpan = document.createElement('span');
          urlSpan.className = 'copy-url-span';
          urlSpan.setAttribute('data-url', url);
          urlSpan.style.cssText = 'flex: 1; font-family: monospace; font-size: 11px; word-break: break-all; cursor: pointer; padding: 4px;';
          urlSpan.title = 'Click to copy full URL: ' + url;
          urlSpan.textContent = 'üìã ' + url;
          
          const copyBtn = document.createElement('button');
          copyBtn.className = 'copy-url-btn';
          copyBtn.setAttribute('data-url', url);
          copyBtn.style.cssText = 'margin-left: 8px; padding: 4px 8px; font-size: 10px; cursor: pointer; border: 1px solid #ddd; border-radius: 3px; background: #f5f5f5;';
          copyBtn.textContent = 'Copy';
          
          itemDiv.appendChild(urlSpan);
          itemDiv.appendChild(copyBtn);
          out.appendChild(itemDiv);
        });
        
        // Wire up checkbox counter and save button
        wireCheckboxHandlers();
        
        panel.style.display = 'grid';
        statusEl.innerHTML = `<span class="pill">Done</span>`;
      } catch (e) {
        out.textContent = 'Error: ' + (e?.message || String(e));
        statusEl.innerHTML = `<span class="pill" style="background:#fdd; color:#900;">Error</span>`;
      }
    };

    // Save (scrape) button with debug panel support
    saveBtn.onclick = async () => {
      showDebugPanel();
      clearDebugOutput();
      addDebugOutput('üöÄ Starting scrape operation for: ' + (urlInput.value || 'current page'), 'info');
      
      statusEl.innerHTML = `<span class="pill">Scraping</span>`;
      panel.style.display = 'none'; images.innerHTML=''; summary.innerHTML=''; out.textContent='';
      try {
        const { result, selectorsUsed } = await window.api.scrapeCurrent({ mode: 'normal' });
        lastPayload = result || {}; lastSelectorsUsed = selectorsUsed || null;
        
        // Display debug log if available
        if (result && result.__debugLog && Array.isArray(result.__debugLog)) {
          result.__debugLog.forEach(entry => {
            const colors = { info: 'info', warning: 'warning', error: 'error', debug: 'debug' };
            
            if (entry.isImage && entry.imageUrl) {
              // Use visual image preview for image debug entries
              addDebugOutputWithImage(
                entry.message, 
                colors[entry.level] || 'info', 
                entry.imageUrl, 
                entry.score, 
                entry.kept
              );
            } else {
              // Regular text debug output
              addDebugOutput(entry.message, colors[entry.level] || 'info');
            }
          });
          addDebugOutput('‚úÖ Debug trace complete', 'success');
        }
        const imgs = Array.isArray(result?.images) ? result.images : [];
        summary.innerHTML = `
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
            <input type="checkbox" id="check_title" data-field="title">
            <label for="check_title" style="flex:1;"><b>Title:</b> ${result?.title || ''}</label>
          </div>
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
            <input type="checkbox" id="check_price" data-field="price">
            <label for="check_price" style="flex:1;"><b>Price:</b> ${result?.price || ''}</label>
          </div>
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
            <input type="checkbox" id="check_brand" data-field="brand">
            <label for="check_brand" style="flex:1;"><b>Brand:</b> ${result?.brand || ''}</label>
          </div>
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
            <input type="checkbox" id="check_url" data-field="url">
            <label for="check_url" style="flex:1;"><b>URL:</b> ${result?.url || ''}</label>
          </div>
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
            <input type="checkbox" id="check_description" data-field="description">
            <label for="check_description" style="flex:1;"><b>Description:</b> ${(result?.description || '').slice(0,240)}</label>
          </div>
          <button id="saveSelectorBtn" style="margin-top:8px; padding:6px 12px; background:#4CAF50; color:white; border:none; border-radius:4px; cursor:pointer;">üíæ Save Selectors (<span id="selectedCount">0</span> selected)</button>`;
        images.innerHTML = imgs.map((u, i) => `
          <div style="position:relative; display:inline-block;">
            <input type="checkbox" class="img-checkbox" data-field="images" data-index="${i}" data-url="${u}" style="position:absolute; top:4px; left:4px; z-index:1; width:16px; height:16px; cursor:pointer;">
            <img referrerpolicy="no-referrer" src="${u}" title="${u}" onclick="openImageOverlay('${u}')" style="display:block;">
          </div>`).join('');
        // Update mobile preview with scraped images
        updateMobilePreview(imgs);
        // Enhanced URL display with click-to-copy functionality (safe DOM approach)
        out.innerHTML = ''; // Clear first
        imgs.forEach((url, index) => {
          const itemDiv = document.createElement('div');
          itemDiv.className = 'image-url-item';
          itemDiv.style.cssText = `display: flex; align-items: center; padding: 4px 0; border-bottom: 1px solid #eee; background: ${index % 2 === 0 ? '#f9f9f9' : 'white'};`;
          
          const urlSpan = document.createElement('span');
          urlSpan.className = 'copy-url-span';
          urlSpan.setAttribute('data-url', url);
          urlSpan.style.cssText = 'flex: 1; font-family: monospace; font-size: 11px; word-break: break-all; cursor: pointer; padding: 4px;';
          urlSpan.title = 'Click to copy full URL: ' + url;
          urlSpan.textContent = 'üìã ' + url;
          
          const copyBtn = document.createElement('button');
          copyBtn.className = 'copy-url-btn';
          copyBtn.setAttribute('data-url', url);
          copyBtn.style.cssText = 'margin-left: 8px; padding: 4px 8px; font-size: 10px; cursor: pointer; border: 1px solid #ddd; border-radius: 3px; background: #f5f5f5;';
          copyBtn.textContent = 'Copy';
          
          itemDiv.appendChild(urlSpan);
          itemDiv.appendChild(copyBtn);
          out.appendChild(itemDiv);
        });
        
        // Wire up checkbox counter and save button
        wireCheckboxHandlers();
        
        panel.style.display = 'grid';
        statusEl.innerHTML = `<span class="pill">Done</span>`;
      } catch (e) {
        out.textContent = 'Error: ' + (e?.message || String(e));
        statusEl.innerHTML = `<span class="pill" style="background:#fdd; color:#900;">Error</span>`;
      }
    };

    // Wire up checkbox handlers
    function wireCheckboxHandlers() {
      const checkboxes = document.querySelectorAll('input[type="checkbox"][data-field]');
      const countSpan = document.getElementById('selectedCount');
      const saveBtn = document.getElementById('saveSelectorBtn');
      
      // Update count on change
      checkboxes.forEach(cb => {
        cb.addEventListener('change', () => {
          const count = Array.from(checkboxes).filter(c => c.checked).length;
          countSpan.textContent = count;
        });
      });
      
      // Save button click
      if (saveBtn) {
        saveBtn.onclick = async () => {
          const checked = Array.from(checkboxes).filter(cb => cb.checked);
          if (checked.length === 0) {
            alert('Please select at least one field to save');
            return;
          }
          
          // Group by field
          const fieldMap = {};
          checked.forEach(cb => {
            const field = cb.dataset.field;
            if (!fieldMap[field]) fieldMap[field] = [];
            
            if (field === 'images') {
              // For images, collect selectors from lastSelectorsUsed
              if (lastSelectorsUsed?.images) {
                const selectors = Array.isArray(lastSelectorsUsed.images.selectors) 
                  ? lastSelectorsUsed.images.selectors 
                  : [lastSelectorsUsed.images.selectors];
                fieldMap[field].push(...selectors);
              }
            } else {
              // For other fields, get selector from lastSelectorsUsed
              if (lastSelectorsUsed?.[field]) {
                const selectors = Array.isArray(lastSelectorsUsed[field].selectors)
                  ? lastSelectorsUsed[field].selectors
                  : [lastSelectorsUsed[field].selectors];
                fieldMap[field].push(...selectors);
              }
            }
          });
          
          // Check for existing selectors and show priority dialog
          const host = currentHost;
          const existing = await window.api.getSelectorMemory(host);
          
          let priority = 'high';
          if (existing && Object.keys(existing).some(k => !['__history', 'host', 'updated'].includes(k))) {
            const choice = confirm('Found existing selectors for this domain.\n\nOK = Add as HIGH priority (new +50, old +25)\nCancel = Replace all (remove old)');
            if (choice) {
              priority = 'high';
              // Keep old selectors, mark as medium
              Object.keys(existing).forEach(field => {
                if (!['__history', 'host', 'updated'].includes(field) && !fieldMap[field]) {
                  existing[field].priority = 'medium';
                  fieldMap[field] = existing[field].selectors || [];
                }
              });
            }
          }
          
          // Save with priority
          const dataToSave = {};
          Object.keys(fieldMap).forEach(field => {
            dataToSave[field] = {
              selectors: [...new Set(fieldMap[field])], // Dedupe
              priority: priority,
              attr: lastSelectorsUsed?.[field]?.attr || 'text'
            };
          });
          
          const saved = await window.api.setSelectorMemory(host, dataToSave, `Saved ${Object.keys(dataToSave).length} fields with ${priority} priority`);
          
          if (saved) {
            alert(`‚úÖ Saved selectors for: ${Object.keys(dataToSave).join(', ')}\nPriority: ${priority.toUpperCase()}`);
          } else {
            alert('‚ùå Failed to save selectors');
          }
        };
      }
    }

    // Save selector memory (unchanged)
    /* COMMENTED OUT: saveMemBtn.onclick - references removed UI elements (okTitle, okPrice, okImages checkboxes)
    saveMemBtn.onclick = async () => {
      const host = currentHost;
      if (!host || !lastPayload) return;
      let displayResults = [];
      const fieldChecks = [
        { field: 'title', checked: okTitle.checked, data: lastPayload.title },
        { field: 'price', checked: okPrice.checked, data: lastPayload.price },
        { field: 'brand', checked: okBrand.checked, data: lastPayload.brand },
        { field: 'description', checked: okDesc.checked, data: lastPayload.description },
        { field: 'images', checked: okImages.checked, data: lastPayload.images }
      ];
      const foundSelectors = {};
      for (const { field, checked, data } of fieldChecks) {
        if (checked && data && lastSelectorsUsed?.[field]) {
          const norm = normalizeSelectorInfo(lastSelectorsUsed[field]);
          if (norm?.selectors?.length) {
            foundSelectors[field] = { selectors: norm.selectors, attr: norm.attr, method: norm.method };
            displayResults.push(`‚úì ${field}: ${norm.selectors.join(', ')}`);
          }
        }
      }
      if (!Object.keys(foundSelectors).length) {
        alert('‚ùå No selectors to save. Scrape first and check desired fields.');
        return;
      }
      const ok = await window.api.setSelectorMemory(host, foundSelectors, 'Manual save via Save button');
      if (ok) alert(`üíæ Saved selectors for ${host}\n\n` + displayResults.join('\n'));
      else alert('‚ùå Failed to save');
    };
    */

    function normalizeSelectorInfo(raw) {
      if (!raw) return null;
      const selectors = Array.isArray(raw.selectors) ? raw.selectors.filter(Boolean)
                       : (raw.selector ? [raw.selector] : []);
      if (!selectors.length) return null;
      return { selectors, attr: raw.attr || 'text', method: raw.method || 'unknown' };
    }

    // DEBUG OUTPUT FUNCTIONS
    function showDebugPanel() {
      document.getElementById('debugPanel').classList.add('show');
    }

    function hideDebugPanel() {
      document.getElementById('debugPanel').classList.remove('show');
    }

    function clearDebugOutput() {
      document.getElementById('debugContent').innerHTML = '';
    }

    function addDebugOutput(message, type = 'info') {
      const debugContent = document.getElementById('debugContent');
      const entry = document.createElement('div');
      entry.className = `debug-entry ${type}`;
      
      const icons = {
        info: '‚ÑπÔ∏è',
        success: '‚úÖ',
        warning: '‚ö†Ô∏è',
        error: '‚ùå',
        debug: 'üêõ'
      };
      
      entry.innerHTML = `
        <span class="debug-icon">${icons[type] || icons.info}</span>
        <span class="debug-message">${message}</span>
      `;
      
      debugContent.appendChild(entry);
      debugContent.scrollTop = debugContent.scrollHeight;
    }

    function addDebugOutputWithImage(message, type, imageUrl, score, kept) {
      const debugContent = document.getElementById('debugContent');
      const entry = document.createElement('div');
      entry.className = `debug-entry ${type}`;
      
      const icons = {
        info: '‚ÑπÔ∏è',
        success: '‚úÖ',
        warning: '‚ö†Ô∏è',
        error: '‚ùå',
        debug: 'üêõ'
      };
      
      entry.innerHTML = `
        <span class="debug-icon">${icons[type] || icons.info}</span>
        <div style="flex: 1;">
          <div class="debug-message">${message}</div>
          <div class="debug-image-preview">
            <img src="${imageUrl}" alt="Debug preview" referrerpolicy="no-referrer">
            <div class="debug-image-info">
              <div>${imageUrl.substring(0, 80)}${imageUrl.length > 80 ? '...' : ''}</div>
            </div>
            <div class="debug-image-score ${kept ? 'kept' : 'rejected'}">${score}</div>
          </div>
        </div>
      `;
      
      debugContent.appendChild(entry);
      debugContent.scrollTop = debugContent.scrollHeight;
    }

    // MOBILE PREVIEW FUNCTIONS
    function updateMobilePreview(imageUrls) {
      const grid = document.getElementById('mobileGrid');
      if (!grid || !Array.isArray(imageUrls)) return;
      
      grid.innerHTML = imageUrls.map((url, index) => `
        <div class="mobile-grid-item" onclick="showMobileImage('${url}', ${index + 1}, ${imageUrls.length})">
          <img src="${url}" alt="Product ${index + 1}" referrerpolicy="no-referrer">
          <div class="mobile-image-number">${index + 1}</div>
        </div>
      `).join('');
    }

    function showMobileImage(url, imageNumber, totalImages) {
      const modal = document.getElementById('mobileModal');
      const image = document.getElementById('mobileModalImage');
      const info = document.getElementById('mobileModalInfo');
      
      image.src = url;
      info.textContent = `Image ${imageNumber} of ${totalImages}`;
      modal.classList.add('show');
    }

    function closeMobileModal() {
      const modal = document.getElementById('mobileModal');
      modal.classList.remove('show');
    }

    // Click event handlers with delegation for dynamically added elements
    document.addEventListener('click', function(e) {
      // Handle copy URL span clicks
      if (e.target.classList.contains('copy-url-span')) {
        const url = e.target.getAttribute('data-url');
        if (url) {
          navigator.clipboard.writeText(url).then(() => {
            const originalText = e.target.textContent;
            e.target.textContent = '‚úÖ Copied!';
            e.target.style.color = '#4CAF50';
            setTimeout(() => {
              e.target.textContent = originalText;
              e.target.style.color = '';
            }, 1500);
          });
        }
      }
      
      // Handle copy URL button clicks
      if (e.target.classList.contains('copy-url-btn')) {
        const url = e.target.getAttribute('data-url');
        if (url) {
          navigator.clipboard.writeText(url).then(() => {
            const originalText = e.target.textContent;
            e.target.textContent = '‚úì';
            e.target.style.background = '#4CAF50';
            e.target.style.color = 'white';
            setTimeout(() => {
              e.target.textContent = originalText;
              e.target.style.background = '';
              e.target.style.color = '';
            }, 1500);
          });
        }
      }
    });

    // Validation Panel Functions
    function showValidationPanel() {
      document.getElementById('validationPanel').style.display = 'block';
    }

    function hideValidationPanel() {
      document.getElementById('validationPanel').style.display = 'none';
    }

    async function validateAndSave() {
      const host = currentHost;
      if (!host) {
        alert('No host detected. Please load a page first.');
        return;
      }

      statusEl.innerHTML = `<span class="pill">Validating...</span>`;
      
      try {
        const results = await window.api.validateSelectors(host);
        
        if (!results || Object.keys(results).length === 0) {
          alert('No selectors found to validate');
          statusEl.innerHTML = `<span class="pill">Ready</span>`;
          return;
        }

        // Display results in validation panel
        displayValidationResults(results, host);
        showValidationPanel();
        statusEl.innerHTML = `<span class="pill">Validation Complete</span>`;
        
      } catch (e) {
        alert('Validation failed: ' + (e?.message || String(e)));
        statusEl.innerHTML = `<span class="pill" style="background:#fdd; color:#900;">Error</span>`;
      }
    }

    function displayValidationResults(results, host) {
      const content = document.getElementById('validationContent');
      if (!content) return;
      
      content.innerHTML = '';
      
      let successCount = 0;
      let failedCount = 0;

      for (const [field, result] of Object.entries(results)) {
        if (result.success) successCount++;
        else failedCount++;

        const card = document.createElement('div');
        card.className = 'field-card';
        
        let bodyContent = '';
        if (result.success) {
          if (field === 'images') {
            const urls = Array.isArray(result.value) ? result.value : [];
            bodyContent = `
              <div class="field-preview"><strong>Found ${urls.length} images</strong></div>
              <div class="image-urls">
                ${urls.map(url => `<div class="image-url">${url}</div>`).join('')}
              </div>
              <div class="field-selector">Selectors: ${result.selectors?.join(', ') || 'N/A'}</div>
            `;
          } else {
            bodyContent = `
              <div class="field-preview">${result.value || 'N/A'}</div>
              <div class="field-selector">Selectors: ${result.selectors?.join(', ') || 'N/A'}</div>
            `;
          }
        } else {
          bodyContent = `
            <div class="field-preview" style="color: #c62828;">No results found</div>
            <div class="field-selector">Attempted: ${result.selectors?.join(', ') || 'N/A'}</div>
          `;
        }
        
        card.innerHTML = `
          <div class="field-header">
            <span>${field.charAt(0).toUpperCase() + field.slice(1)}</span>
            <span class="field-status ${result.success ? 'success' : 'failed'}">
              ${result.success ? '‚úì Working' : '‚úó Failed'}
            </span>
          </div>
          <div class="field-body">${bodyContent}</div>
        `;
        
        content.appendChild(card);
      }

      // Update summary
      const summary = document.getElementById('validationSummary');
      if (summary) {
        summary.textContent = `${successCount} working, ${failedCount} failed`;
      }
    }

    async function clearSelectorMemory() {
      const host = currentHost;
      if (!host) {
        alert('No host detected');
        return;
      }
      
      if (!confirm(`Clear all selector memory for ${host}?`)) return;
      
      const success = await window.api.clearSelectorMemory(host);
      if (success) {
        alert('‚úÖ Selector memory cleared');
        hideValidationPanel();
      } else {
        alert('‚ùå Failed to clear memory');
      }
    }

    // AI SUGGESTION FUNCTIONS
    let currentSuggestions = {};

    async function suggestSelector(field) {
      // Check if AI cache is ready
      if (!aiCacheReady) {
        alert('‚ö†Ô∏è Run ü§ñ Batch AI All first!\n\nIndividual AI buttons work by retrieving from the batch AI cache. Please run Batch AI All to warm the cache, then use individual buttons to review specific fields.');
        return;
      }

      const btn = event.target;
      const panel = document.getElementById(`suggestion_${field}`);
      
      // Toggle panel visibility
      if (panel.style.display === 'block') {
        panel.style.display = 'none';
        return;
      }

      btn.disabled = true;
      btn.textContent = '...';

      try {
        const host = currentHost;
        const response = await window.api.getAISuggestion(host, field);
        
        if (response.success && response.suggestion) {
          currentSuggestions[field] = response.suggestion;
          
          // Get baseline (current) selector
          const baseline = lastSelectorsUsed?.[field]?.selectors?.join(', ') || 'None';
          
          // Display comparison
          const comparisonHtml = `
            <div class="suggestion-comparison">
              <div class="suggestion-box">
                <strong>Current:</strong><br>
                ${baseline}
              </div>
              <div class="suggestion-box">
                <strong>AI Suggests:</strong><br>
                ${response.suggestion.selectors.join(', ')}
              </div>
            </div>
            <div style="margin-top: 6px; font-size: 11px; color: #666;">
              Reason: ${response.suggestion.reasoning || 'N/A'}
            </div>
            <button class="use-suggestion-btn" onclick="useSuggestion('${field}')">Use AI Suggestion</button>
          `;
          
          panel.innerHTML = comparisonHtml;
          panel.style.display = 'block';
        } else {
          panel.innerHTML = `<div style="color: #c62828;">Failed: ${response.error || 'Unknown error'}</div>`;
          panel.style.display = 'block';
        }
      } catch (e) {
        panel.innerHTML = `<div style="color: #c62828;">Error: ${e.message}</div>`;
        panel.style.display = 'block';
      } finally {
        btn.disabled = false;
        btn.textContent = 'AI';
      }
    }

    async function useSuggestion(field) {
      const suggestion = currentSuggestions[field];
      if (!suggestion) {
        alert('No suggestion available');
        return;
      }

      const host = currentHost;
      const dataToSave = {
        [field]: {
          selectors: suggestion.selectors,
          attr: suggestion.attr || 'text'
        }
      };

      const success = await window.api.setSelectorMemory(host, dataToSave, `AI suggestion for ${field}`);
      
      if (success) {
        alert(`‚úÖ Saved AI suggestion for ${field}`);
        document.getElementById(`suggestion_${field}`).style.display = 'none';
      } else {
        alert('‚ùå Failed to save suggestion');
      }
    }

    // Add batch AI button functionality
    document.getElementById('batchAIBtn')?.addEventListener('click', async () => {
      await handleBatchAISuggestion();
    });

    // Copy Diagnostics Button Handler
    document.getElementById('copyDiagnosticsBtn')?.addEventListener('click', async () => {
      try {
        const diagnosticData = {
          url: currentUrl,
          host: currentHost,
          timestamp: new Date().toISOString(),
          scrapeResult: lastPayload,
          selectorsUsed: lastSelectorsUsed,
          userAgent: navigator.userAgent,
          viewport: {
            width: window.innerWidth,
            height: window.innerHeight
          }
        };

        const formattedDiagnostics = JSON.stringify(diagnosticData, null, 2);
        
        await navigator.clipboard.writeText(formattedDiagnostics);
        
        const btn = document.getElementById('copyDiagnosticsBtn');
        const originalText = btn.textContent;
        btn.textContent = '‚úÖ Copied!';
        btn.style.background = '#4CAF50';
        
        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = '';
        }, 2000);
        
      } catch (e) {
        alert('Failed to copy diagnostics: ' + e.message);
      }
    });

    // Helper function to check AI cache readiness
    async function checkAICacheStatus() {
      if (!currentHost) return;
      
      try {
        const status = await window.api.checkAICacheStatus(currentHost);
        const statusEl = document.getElementById('aiCacheStatus');
        
        if (status && status.ready) {
          aiCacheReady = true;
          statusEl.textContent = 'ü§ñ AI cache: Ready (' + status.cachedFields.length + ' fields)';
          statusEl.className = 'ai-cache-status ready';
        } else {
          aiCacheReady = false;
          statusEl.textContent = 'ü§ñ AI cache: Not Ready';
          statusEl.className = 'ai-cache-status';
        }
      } catch (e) {
        console.error('Failed to check AI cache status:', e);
      }
    }

    // Check AI cache status when URL changes
    let lastCheckedHost = '';
    setInterval(() => {
      if (currentHost && currentHost !== lastCheckedHost) {
        lastCheckedHost = currentHost;
        checkAICacheStatus();
      }
    }, 1000);

    async function handleBatchAISuggestion() {
      if (!currentHost) {
        alert('Please load a page first');
        return;
      }

      const btn = document.getElementById('batchAIBtn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'ü§ñ Processing...';
      statusEl.innerHTML = `<span class="pill">AI Processing...</span>`;

      try {
        const response = await window.api.getBatchAISuggestions(currentHost);
        
        let resultMsg = '';
        let foundSuggestions = 0;
        
        if (response.success && response.results) {
          const results = response.results;
          foundSuggestions = Object.keys(results).length;
          
          // Update AI cache status
          aiCacheReady = true;
          document.getElementById('aiCacheStatus').textContent = 'ü§ñ AI cache: Ready (' + foundSuggestions + ' fields)';
          document.getElementById('aiCacheStatus').className = 'ai-cache-status ready';
          
          // Show validation-style panel with results
          displayBatchAIResults(results, currentHost);
          showValidationPanel();
          
          resultMsg = `‚úÖ Found ${foundSuggestions} AI suggestions`;
          statusEl.innerHTML = `<span class="pill">${resultMsg}</span>`;
          
        } else {
          resultMsg = `‚ùå Batch AI failed: ${response.error || 'Unknown error'}`;
        }
        
        alert(resultMsg);
        
      } catch (e) {
        alert('Batch AI error: ' + (e?.message || String(e)));
        statusEl.innerHTML = `<span class="pill" style="background:#fdd; color:#900;">Error</span>`;
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    function displayBatchAIResults(results, host) {
      const content = document.getElementById('validationContent');
      if (!content) return;
      
      content.innerHTML = '';
      
      const fields = Object.keys(results);
      
      for (const field of fields) {
        const result = results[field];
        
        const card = document.createElement('div');
        card.className = 'field-card';
        
        let bodyContent = '';
        if (result && result.selectors && result.selectors.length > 0) {
          // Get baseline selector if available
          const baseline = lastSelectorsUsed?.[field]?.selectors?.join(', ') || 'None';
          
          bodyContent = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
              <div class="suggestion-box">
                <strong>Current:</strong><br>
                ${baseline}
              </div>
              <div class="suggestion-box">
                <strong>AI Suggests:</strong><br>
                ${result.selectors.join(', ')}
              </div>
            </div>
            <div style="margin-top: 6px; font-size: 11px; color: #666;">
              <strong>Reasoning:</strong> ${result.reasoning || 'N/A'}
            </div>
            <div style="margin-top: 8px;">
              <input type="checkbox" id="ai_check_${field}" data-field="${field}">
              <label for="ai_check_${field}">Apply this AI suggestion</label>
            </div>
          `;
        } else {
          bodyContent = `
            <div class="field-preview" style="color: #666;">No AI suggestion available</div>
          `;
        }
        
        card.innerHTML = `
          <div class="field-header">
            <span>${field.charAt(0).toUpperCase() + field.slice(1)}</span>
          </div>
          <div class="field-body">${bodyContent}</div>
        `;
        
        content.appendChild(card);
      }

      // Update footer with Apply button
      const footer = document.querySelector('.validation-footer');
      if (footer) {
        footer.innerHTML = `
          <button onclick="hideValidationPanel()" style="padding: 8px 16px; background: #ccc; border: none; border-radius: 4px; cursor: pointer;">
            Cancel
          </button>
          <button onclick="applySelectedAISuggestions('${host}')" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Apply Selected
          </button>
        `;
      }
    }

    async function applySelectedAISuggestions(host) {
      const checkboxes = document.querySelectorAll('[id^="ai_check_"]:checked');
      
      if (checkboxes.length === 0) {
        alert('Please select at least one AI suggestion to apply');
        return;
      }

      const dataToSave = {};
      
      for (const checkbox of checkboxes) {
        const field = checkbox.dataset.field;
        
        // Get suggestion from AI cache
        const response = await window.api.getAISuggestion(host, field);
        
        if (response.success && response.suggestion) {
          dataToSave[field] = {
            selectors: response.suggestion.selectors,
            attr: response.suggestion.attr || 'text'
          };
        }
      }

      if (Object.keys(dataToSave).length > 0) {
        const success = await window.api.setSelectorMemory(host, dataToSave, `Batch AI suggestion for ${Object.keys(dataToSave).join(', ')}`);
        
        // Check the corresponding checkbox
        Object.keys(dataToSave).forEach(field => {
          const checkbox = document.getElementById(`check_${field}`);
          if (checkbox) checkbox.checked = true;
        });
        
        if (success) {
          alert(`‚úÖ Applied AI suggestions for: ${Object.keys(dataToSave).join(', ')}`);
          hideValidationPanel();
        } else {
          alert('‚ùå Failed to apply suggestions');
        }
      }
    }

    urlInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') visitBtn.click(); });

    /* === LLM (compare) minimal hook === */
    (function(){
      const btn = document.getElementById('llmCompareBtn');
      if (!btn) return;

      btn.onclick = async () => {
        const url = urlInput.value.trim() || currentUrl;
        if (!url) return alert('Paste a URL first.');

        statusEl.innerHTML = `<span class="pill">LLM compare...</span>`;
        panel.style.display = 'none';
        out.textContent = '';

        try {
          const { baseline, llm } = await window.api.scrapeWithLLMCompare(url);

          // baseline: scraped from baseline orchestrator
          // llm: scraped from LLM orchestrator
          out.innerHTML = `
<h3>Baseline (Normal)</h3>
<div><b>Title:</b> ${baseline?.title || ''}</div>
<div><b>Price:</b> ${baseline?.price || ''}</div>
<div><b>Brand:</b> ${baseline?.brand || ''}</div>
<div><b>Images:</b> ${baseline?.images?.length || 0}</div>

<h3 style="margin-top:16px;">LLM (Experimental)</h3>
<div><b>Title:</b> ${llm?.title || ''}</div>
<div><b>Price:</b> ${llm?.price || ''}</div>
<div><b>Brand:</b> ${llm?.brand || ''}</div>
<div><b>Images:</b> ${llm?.images?.length || 0}</div>
          `;

          statusEl.innerHTML = `<span class="pill">LLM compare done</span>`;
        } catch (e) {
          out.textContent = 'LLM compare error: ' + (e?.message || String(e));
          statusEl.innerHTML = `<span class="pill" style="background:#fdd;color:#900;">Error</span>`;
        }
      };
    })();
  </script>

  <!-- Validation Panel Structure -->
  <div class="validation-panel" id="validationPanel">
    <div class="validation-header">
      <span>ü§ñ Batch AI Results - Review & Apply</span>
      <button onclick="hideValidationPanel()" style="background: none; border: none; font-size: 18px; cursor: pointer;">&times;</button>
    </div>
    <div class="validation-content" id="validationContent">
      <!-- Results will be populated here -->
    </div>
    <div class="validation-footer">
      <button onclick="hideValidationPanel()" style="padding: 8px 16px; background: #ccc; border: none; border-radius: 4px; cursor: pointer;">
        Cancel
      </button>
      <button onclick="clearSelectorMemory()" style="padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">
        Clear Memory
      </button>
    </div>
  </div>
</body>
</html>
