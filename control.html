<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Tagglo Control</title>
  <style>
    body { font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 18px; color:#111; }
    .row { display:flex; gap:8px; align-items:center; margin-bottom:10px; }
    input[type="text"] { width: 560px; padding:8px 10px; border:1px solid #ccc; border-radius:6px; }
    button { padding:8px 12px; border:0; border-radius:6px; background:#111; color:#fff; cursor:pointer; }
    button[disabled] { opacity:.5; cursor:not-allowed; }
    #out { white-space: pre; background:#fafafa; border:1px solid #eee; padding:10px; border-radius:8px; margin-top:12px; max-height: 44vh; overflow:auto; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; }
    .pill { display:inline-block; background:#eee; border-radius:999px; padding:2px 8px; margin-right:6px; font-size:12px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .box { border:1px solid #eee; border-radius:8px; padding:10px; background:#fff; }
    .label { font-weight:700; margin-bottom:4px; }
    .imgs { display:flex; gap:6px; flex-wrap:wrap; }
    .imgs img { height:64px; border-radius:6px; border:1px solid #eee; cursor:pointer; transition:transform 0.2s; }
    .imgs img:hover { transform:scale(1.05); }

    /* Image Overlay Modal */
    .image-overlay { 
      position:fixed; top:0; left:0; width:100%; height:100%; 
      background:rgba(0,0,0,0.9); display:none; z-index:1000; 
      justify-content:center; align-items:center; 
    }
    .image-overlay.show { display:flex; }
    .overlay-content { 
      position:relative; max-width:90%; max-height:90%; 
      display:flex; justify-content:center; align-items:center; 
    }
    .overlay-image { 
      max-width:100%; max-height:100%; object-fit:contain; 
      border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,0.5); 
    }
    .close-overlay { 
      position:absolute; top:-40px; right:0; background:none; 
      border:none; color:white; font-size:24px; cursor:pointer; 
      padding:8px; border-radius:4px; 
    }
    .close-overlay:hover { background:rgba(255,255,255,0.2); }
  </style>
</head>
<body>
  <div class="row">
    <input id="urlInput" type="text" placeholder="Paste product URL" />
    <button id="visitBtn">Load</button>
    <button id="memoryBtn" title="Scrape using saved selector memory only">Selector memory</button>
    <button id="saveBtn" disabled>Save (scrape)</button>
    <!-- LLM (compare) button — added -->
    <button id="llmCompareBtn" title="Side-by-side baseline vs LLM">LLM (compare)</button>
  </div>

  <div id="status"></div>

  <div id="panel" class="grid" style="display:none; margin-top:12px;">
    <div class="box">
      <div class="label">Scrape Result</div>
      <div id="summary"></div>
      <div id="images" class="imgs" style="margin-top:6px;"></div>
    </div>
    <div class="box">
      <div class="label">Saved Selector Validation</div>
      <div id="validationPanel" style="margin-bottom: 12px; padding: 8px; background: #f5f5f5; border-radius: 4px; border-left: 4px solid #2196F3;">
        <div style="font-weight: bold; margin-bottom: 6px; color: #333; font-size: 12px;">Current Domain Selectors:</div>
        <div id="validationResults" style="font-size: 11px; line-height: 1.4;">
          <div style="color: #666; font-style: italic;">Click "Test Saved Selectors" to validate</div>
        </div>
        <button id="validateBtn" style="margin-top: 6px; padding: 4px 8px; background: #2196F3; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">Test Saved Selectors</button>
      </div>

      <div class="label">Selector Memory (approve to save)</div>
      <div>
        <label><input type="checkbox" id="okTitle"> Title OK</label>
        <label style="margin-left:12px;"><input type="checkbox" id="okPrice"> Price OK</label>
        <label style="margin-left:12px;"><input type="checkbox" id="okImages"> Images OK</label>
        <br>
        <label><input type="checkbox" id="okBrand"> Brand OK</label>
        <label style="margin-left:12px;"><input type="checkbox" id="okTags"> Tags OK</label>
        <label style="margin-left:12px;"><input type="checkbox" id="okDesc"> Description OK</label>
      </div>
      <div id="memDebug" style="margin-top:8px; font-size:12px; opacity:.8;"></div>
      <div style="margin-top:8px;">
        <button id="saveMemBtn">Save selectors for this host</button>
        <button id="clearMemBtn" style="background:#b22;">Clear memory (host)</button>
      </div>
    </div>
  </div>

  <div class="label" style="margin-top:10px;">Image URLs (top 20)</div>
  <div id="out" title="Only image URLs appear here"></div>

  <script>
    const urlInput = document.getElementById('urlInput');
    const visitBtn = document.getElementById('visitBtn');
    const memoryBtn = document.getElementById('memoryBtn');
    const saveBtn  = document.getElementById('saveBtn');
    const statusEl = document.getElementById('status');

    const panel = document.getElementById('panel');
    const summary = document.getElementById('summary');
    const images = document.getElementById('images');
    const out = document.getElementById('out');

    const okTitle = document.getElementById('okTitle');
    const okPrice = document.getElementById('okPrice');
    const okImages = document.getElementById('okImages');
    const okBrand = document.getElementById('okBrand');
    const okTags  = document.getElementById('okTags');
    const okDesc  = document.getElementById('okDesc');
    const saveMemBtn = document.getElementById('saveMemBtn');
    const clearMemBtn = document.getElementById('clearMemBtn');
    const memDebug = document.getElementById('memDebug');
    const validateBtn = document.getElementById('validateBtn');
    const validationResults = document.getElementById('validationResults');

    function setSaveState(disabled, label) {
      saveBtn.disabled = disabled;
      saveBtn.textContent = label || (disabled ? 'Waiting for page…' : 'Save (scrape)');
    }
    function hostFrom(url) {
      try { return new URL(url).host.replace(/^www\./,''); } catch { return null; }
    }

    let currentHost = null;
    let lastSelectorsUsed = null;
    let lastPayload = null;

    function normalizeSelectorInfo(selectorInfo) {
      if (!selectorInfo) return null;
      if (selectorInfo && Array.isArray(selectorInfo.selectors)) {
        const sels = selectorInfo.selectors.filter(Boolean).slice(0, 8);
        return { selectors: sels, attr: selectorInfo.attr || 'text', method: selectorInfo.method || 'tracked' };
      }
      if (selectorInfo && typeof selectorInfo.selector === 'string') {
        const s = selectorInfo.selector;
        if (/^(generic-text-selector|custom-handler|generic-images)$/i.test(s)) return null;
        return { selectors: [s], attr: selectorInfo.attr || 'text', method: selectorInfo.method || 'tracked' };
      }
      if (typeof selectorInfo === 'string') {
        const s = selectorInfo.trim();
        const looksCss = /[#.\[\s>:]/.test(s) || s.startsWith('meta') || s.startsWith('img');
        if (!looksCss) return null;
        return { selectors: [s], attr: 'text', method: 'tracked' };
      }
      return null;
    }

    // Load (navigate only)
    visitBtn.onclick = async () => {
      const url = urlInput.value.trim();
      if (!url) return;
      currentHost = hostFrom(url);
      panel.style.display = 'none';
      out.textContent = '';
      images.innerHTML = '';
      summary.innerHTML = '';
      statusEl.innerHTML = `<span class="pill">Loading ${currentHost}</span>`;
      await window.api.openProduct(url);

      // poll readiness and enable Save once likely hydrated
      setSaveState(true, 'Waiting for page…');
      const iv = setInterval(async () => {
        const ok = await window.api.evalInProduct(`
          (async () => {
            const h1 = document.querySelector("h1,[itemprop='name']");
            const price = document.querySelector("[itemprop='price'],[data-price],[class*='price'] .money");
            const imgs = document.querySelector("img[src], picture source[srcset], [data-zoom-image], [data-large-image]");
            return !!(h1 && (price || imgs));
          })();
        `);
        if (ok) {
          clearInterval(iv);
          statusEl.innerHTML = `<span class="pill">Ready</span>`;
          setSaveState(false);
          setTimeout(autoValidateIfNeeded, 500);
        }
      }, 700);
    };

    // Selector memory only
    memoryBtn.onclick = async () => {
      const url = urlInput.value.trim();
      if (!url) return alert('Paste a URL first.');
      const host = hostFrom(url);
      // First navigate to the target page to be in correct origin
      statusEl.innerHTML = `<span class="pill">Loading ${host}</span>`;
      panel.style.display = 'none'; images.innerHTML=''; summary.innerHTML=''; out.textContent='';
      
      await window.api.openProduct(url);
      await new Promise(r => setTimeout(r, 1500)); // Wait for page load
      
      const hasMem = await window.api.hasSelectorMemory(host);
      if (!hasMem) { 
        statusEl.innerHTML = `<span class="pill" style="background:#fdd; color:#900;">No Memory</span>`;
        alert('❌ No selector memory for this host yet. Use "Save (Scrape)" first.');
        return;
      }
      
      statusEl.innerHTML = `<span class="pill">Memory-only</span>`;
      try {
        const { result, selectorsUsed } = await window.api.scrapeCurrent({ mode: 'memoryOnly' });
        lastPayload = result || {}; lastSelectorsUsed = selectorsUsed || null;
        const imgs = Array.isArray(result?.images) ? result.images : [];
        summary.innerHTML = `
          <div><b>Title:</b> ${result?.title || ''}</div>
          <div><b>Price:</b> ${result?.price || ''}</div>
          <div><b>Brand:</b> ${result?.brand || ''}</div>
          <div><b>URL:</b> ${result?.url || ''}</div>
          <div><b>Description:</b> ${(result?.description || '').slice(0,240)}</div>`;
        images.innerHTML = imgs.map(u => `<img referrerpolicy="no-referrer" src="${u}" title="${u}" onclick="openImageOverlay('${u}')">`).join('');
        out.textContent = imgs.join('\\n');
        panel.style.display = 'grid';
        statusEl.innerHTML = `<span class="pill">Done</span>`;
      } catch (e) {
        out.textContent = 'Error: ' + (e?.message || String(e));
        statusEl.innerHTML = `<span class="pill" style="background:#fdd; color:#900;">Error</span>`;
      }
    };

    // Save (scrape)
    saveBtn.onclick = async () => {
      statusEl.innerHTML = `<span class="pill">Scraping</span>`;
      panel.style.display = 'none'; images.innerHTML=''; summary.innerHTML=''; out.textContent='';
      try {
        const { result, selectorsUsed } = await window.api.scrapeCurrent({ mode: 'normal' });
        lastPayload = result || {}; lastSelectorsUsed = selectorsUsed || null;
        const imgs = Array.isArray(result?.images) ? result.images : [];
        summary.innerHTML = `
          <div><b>Title:</b> ${result?.title || ''}</div>
          <div><b>Price:</b> ${result?.price || ''}</div>
          <div><b>Brand:</b> ${result?.brand || ''}</div>
          <div><b>URL:</b> ${result?.url || ''}</div>
          <div><b>Description:</b> ${(result?.description || '').slice(0,240)}</div>`;
        images.innerHTML = imgs.map(u => `<img referrerpolicy="no-referrer" src="${u}" title="${u}" onclick="openImageOverlay('${u}')">`).join('');
        out.textContent = imgs.join('\\n');
        panel.style.display = 'grid';
        statusEl.innerHTML = `<span class="pill">Done</span>`;
      } catch (e) {
        out.textContent = 'Error: ' + (e?.message || String(e));
        statusEl.innerHTML = `<span class="pill" style="background:#fdd; color:#900;">Error</span>`;
      }
    };

    // Save selector memory (unchanged)
    saveMemBtn.onclick = async () => {
      const host = currentHost;
      if (!host || !lastPayload) return;
      let displayResults = [];
      const fieldChecks = [
        { field: 'title', checked: okTitle.checked, data: lastPayload.title },
        { field: 'price', checked: okPrice.checked, data: lastPayload.price },
        { field: 'brand', checked: okBrand.checked, data: lastPayload.brand },
        { field: 'description', checked: okDesc.checked, data: lastPayload.description },
        { field: 'images', checked: okImages.checked, data: lastPayload.images }
      ];
      const foundSelectors = {};
      for (const { field, checked, data } of fieldChecks) {
        if (checked && data && lastSelectorsUsed?.[field]) {
          const norm = normalizeSelectorInfo(lastSelectorsUsed[field]);
          if (norm?.selectors?.length) {
            foundSelectors[field] = { selectors: norm.selectors, attr: norm.attr, method: norm.method };
            displayResults.push(`✓ ${field}: ${norm.selectors.join(', ')}`);
          } else {
            displayResults.push(`❌ ${field}: no valid selector`);
          }
        }
      }
      if (!Object.keys(foundSelectors).length) {
        memDebug.innerHTML = `<div style="color:#d32f2f;">❌ No tracked selectors available to save.</div>`;
        return;
      }
      await window.api.setSelectorMemory(host, foundSelectors, `Saved ${new Date().toISOString()}`);
      memDebug.innerHTML = `<div style="color:#2d5a27;">✅ Saved selectors.</div>`;
    };

    clearMemBtn.onclick = async () => {
      if (!currentHost) return;
      const confirmed = confirm('Clear all saved selectors for this domain?');
      if (!confirmed) return;
      await window.api.clearSelectorMemory(currentHost);
      memDebug.innerHTML = '<div style="color:#666;">No saved selectors for this domain</div>';
      validationResults.innerHTML = '<div style="color:#666; font-style:italic;">No saved selectors found</div>';
      alert('Cleared.');
    };

    validateBtn.onclick = async () => {
      if (!currentHost) return;
      validateBtn.textContent = 'Testing…'; validateBtn.disabled = true;
      try {
        const results = await window.api.validateSelectors(currentHost);
        displayValidationResults(results);
      } finally {
        validateBtn.textContent = 'Test Saved Selectors'; validateBtn.disabled = false;
      }
    };

    function displayValidationResults(results) {
      if (!results.savedSelectors || Object.keys(results.savedSelectors).length === 0) {
        validationResults.innerHTML = '<div style="color:#666; font-style:italic;">No saved selectors found for this domain</div>';
        return;
      }
      const fieldResults = [];
      Object.entries(results.savedSelectors).forEach(([field, selectorConfig]) => {
        const testResult = results.testResults[field];
        const status = testResult?.success || false;
        const value = testResult?.value ?? '';
        const error = testResult?.error || '';
        const source = testResult?.source || 'unknown';
        let icon, color, statusText;
        if (status) {
          icon = '✅'; color = '#2d5a27';
          const valueStr = Array.isArray(value) ? `${value.length} items` : String(value);
          const truncatedValue = valueStr.slice(0, 60) + (valueStr.length > 60 ? '...' : '');
          const sourceInfo = source === 'memory' ? '(saved selector)' : source === 'generic-fallback' ? '(fallback)' : '';
          statusText = `Found: "${truncatedValue}" ${sourceInfo}`;
        } else {
          icon = '❌'; color = '#d32f2f'; statusText = error || 'Not found';
        }
        const selectors = Array.isArray(selectorConfig.selectors) ? selectorConfig.selectors : [selectorConfig.selectors];
        fieldResults.push(`
          <div style="margin-bottom:4px; padding:3px 0;">
            <span style="color:${color};">${icon}</span>
            <strong>${field}:</strong> 
            <code style="background:#eee; padding:1px 4px; border-radius:2px; font-size:10px;">${selectors.join(', ')}</code>
            <div style="font-size:10px; color:#666; margin-left:20px;">${statusText}</div>
          </div>`);
      });
      const successCount = Object.values(results.testResults).filter(r => r && r.success).length;
      const totalCount = Object.keys(results.savedSelectors).length;
      validationResults.innerHTML = `
        <div style="margin-bottom:6px; font-weight:bold; color:#333;">Results (${successCount}/${totalCount} working):</div>
        ${fieldResults.join('')}`;
    }

    async function autoValidateIfNeeded() {
      if (!currentHost) return;
      try {
        const memory = await window.api.getSelectorMemory(currentHost);
        if (memory && Object.keys(memory).length > 0) {
          const results = await window.api.validateSelectors(currentHost);
          displayValidationResults(results);
        }
      } catch {}
    }

    // Image overlay
    function openImageOverlay(imageUrl) {
      const overlay = document.getElementById('imageOverlay');
      const overlayImage = document.getElementById('overlayImage');
      overlayImage.src = imageUrl;
      overlay.classList.add('show');
    }
    function closeImageOverlay() {
      document.getElementById('imageOverlay').classList.remove('show');
    }
    document.getElementById('imageOverlay').addEventListener('click', (e) => {
      if (e.target.id === 'imageOverlay') closeImageOverlay();
    });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeImageOverlay(); });
    urlInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') visitBtn.click(); });

    /* === LLM (compare) minimal hook === */
    (function(){
      const btn = document.getElementById('llmCompareBtn');
      if (!btn) return;
      btn.addEventListener('click', async () => {
        const url = (document.getElementById('urlInput')?.value || '').trim();
        if (!url) { alert('Paste a URL first.'); return; }
        try {
          await window.api.openCompare?.(url);
        } catch (e) {
          alert('Compare window failed. Make sure main_bridge.js is required from main.js');
        }
      });
    })();
  </script>

  <!-- Image Overlay Modal -->
  <div id="imageOverlay" class="image-overlay">
    <div class="overlay-content">
      <button class="close-overlay" onclick="closeImageOverlay()">&times;</button>
      <img id="overlayImage" class="overlay-image" src="" alt="Full size image">
    </div>
  </div>
</body>
</html>
